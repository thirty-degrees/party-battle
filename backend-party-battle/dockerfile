ARG NODE_VERSION=24-alpine

FROM node:${NODE_VERSION} AS deps
WORKDIR /app

COPY package.json package-lock.json ./
COPY types-party-battle/package.json types-party-battle/package.json
COPY backend-party-battle/package.json backend-party-battle/package.json
RUN npm ci --omit=dev --workspace backend-party-battle --include-workspace-root=false

FROM node:${NODE_VERSION} AS builder
WORKDIR /app

COPY package.json package-lock.json ./
COPY types-party-battle types-party-battle
COPY backend-party-battle backend-party-battle
RUN npm ci --workspace types-party-battle --workspace backend-party-battle --include-workspace-root=false

RUN npm run -w types-party-battle build
RUN npm run -w backend-party-battle build

FROM node:${NODE_VERSION} AS runner
WORKDIR /app

ENV NODE_ENV=production

COPY --from=deps /app/node_modules ./node_modules
COPY --from=builder /app/backend-party-battle/package.json ./backend-party-battle/package.json
COPY --from=builder /app/types-party-battle/package.json ./node_modules/types-party-battle/package.json
COPY --from=builder /app/backend-party-battle/build ./backend-party-battle/build
COPY --from=builder /app/types-party-battle/dist ./node_modules/types-party-battle/dist

WORKDIR /app/backend-party-battle
EXPOSE 2567
CMD ["node", "build/index.js"]
